---
import { schemaJson } from './lib/structuredData'
import {
  generateCrumbs,
  mergeCustomizedLinks,
  customizeListElement,
  processParts,
} from './lib/generateCrumbs'
import BreadcrumbLink from './BreadcrumbLink.astro'
import BreadcrumbSeparator from './BreadcrumbSeparator.astro'
import type { BreadcrumbsProps } from './breadcrumbs.types.ts'
import { debugInformation } from './lib/debug.ts'

const {
  indexText = 'Home',
  mainBemClass = 'c-breadcrumbs',
  ariaLabel = 'breadcrumbs',
  crumbs = [],
  customizeLinks = [],
  customizeListElements = [],
  customizeList = {},
  customizeNav = {},
  schemaJsonScript = true,
  ellipsisAriaLabel = 'Show hidden navigation',
  truncated = false,
  linkTextFormat,
  customBaseUrl,
  excludeCurrentPage = false,
  debug = false,
  separatorAriaHidden = true,
  id = crypto.randomUUID(),
  cssClasses,
} = Astro.props as BreadcrumbsProps

const paths = Astro.url.pathname.split('/').filter((crumb: any) => crumb)
const hasTrailingSlash = Astro.url.pathname.endsWith('/')
const pathLength = paths?.length
const disableDefaultStyles = cssClasses?.disableDefaultClasses ?? false
const listCssClasses = [
  !disableDefaultStyles && `${mainBemClass}__crumbs`,
  !disableDefaultStyles &&
    (Astro.slots.has('separator') ? 'has-separators' : 'has-no-separators'),
  cssClasses?.list,
]

const parts = generateCrumbs({
  crumbs,
  paths,
  indexText,
  hasTrailingSlash,
  linkTextFormat,
  customBaseUrl,
})

const customizedParts = mergeCustomizedLinks(parts, customizeLinks)

const processedParts = processParts(
  customizedParts,
  customizeListElements,
  excludeCurrentPage,
  truncated,
  pathLength,
)

debugInformation(debug, parts, customizedParts)
---

<astro-breadcrumbs
  data-main-bem-class={mainBemClass}
  data-id={id}
  data-path-length={pathLength}
  data-truncated={truncated}
>
  <nav
    aria-label={ariaLabel}
    class:list={[!disableDefaultStyles && mainBemClass, cssClasses?.container]}
    id={id}
    {...customizeNav}
  >
    <ol class:list={listCssClasses} {...customizeList}>
      {
        processedParts.map(
          ({ text, isLast, showTruncatedButton, ...attrs }, index) => {
            return (
              <>
                {showTruncatedButton && (
                  <li
                    class:list={[
                      !disableDefaultStyles && `${mainBemClass}__crumb`,
                      !disableDefaultStyles && 'has-ellipsis',
                      cssClasses?.item,
                    ]}
                    data-crumb
                    {...customizeListElements[1]}
                  >
                    <button
                      type='button'
                      aria-label={ellipsisAriaLabel}
                      class:list={[
                        !disableDefaultStyles &&
                          `${mainBemClass}__truncated-button`,
                        cssClasses?.truncatedButton,
                      ]}
                      data-truncated-button
                    >
                      <slot name='ellipsis'>â€¦</slot>
                    </button>
                    <BreadcrumbSeparator
                      mainBemClass={mainBemClass}
                      separatorAriaHidden={separatorAriaHidden}
                      disableDefaultStyles={disableDefaultStyles}
                      separatorClass={cssClasses?.separator}
                    >
                      <slot name='separator' slot='separator' />
                    </BreadcrumbSeparator>
                  </li>
                )}
                <li
                  class:list={[
                    !disableDefaultStyles && `${mainBemClass}__crumb`,
                    cssClasses?.item,
                  ]}
                  data-crumb
                  {...customizeListElement(
                    index,
                    showTruncatedButton,
                    customizeListElements
                  )}
                >
                  <BreadcrumbLink
                    attrs={attrs}
                    mainBemClass={mainBemClass}
                    isIndex={index === 0}
                    isCurrent={isLast}
                    disableDefaultStyles={disableDefaultStyles}
                    linkClass={cssClasses?.link}
                  >
                    {Astro.slots.has('index') && index === 0 ? (
                      <slot name='index' slot='index' />
                    ) : (
                      decodeURI(text)
                    )}
                  </BreadcrumbLink>

                  {Astro.slots.has('separator') && !isLast && (
                    <BreadcrumbSeparator
                      mainBemClass={mainBemClass}
                      separatorAriaHidden={separatorAriaHidden}
                      disableDefaultStyles={disableDefaultStyles}
                      separatorClass={cssClasses?.separator}
                    >
                      <slot name='separator' slot='separator' />
                    </BreadcrumbSeparator>
                  )}
                </li>
              </>
            );
          }
        )
      }
    </ol>
  </nav>
</astro-breadcrumbs>
{
  schemaJsonScript && (
    <script type='application/ld+json' set:html={schemaJson(customizedParts)} />
  )
}

<script>
  import { Truncated } from './lib/truncated';

  if (!customElements.get('astro-breadcrumbs')) {
    customElements.define('astro-breadcrumbs', Truncated);
  }
</script>
